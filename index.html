<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å¤©æ°”é¢„æŠ¥</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass: rgba(255, 255, 255, 0.2);
            --text-main: #ffffff;
            --warn-color: #ff4d4d;
            --active-city: rgba(255, 255, 255, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
        }

        .search-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        #city-search {
            flex: 1;
            padding: 12px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(5px);
            outline: none;
            font-size: 1rem;
            transition: 0.3s;
        }
        #city-search:focus {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }
        #city-search::placeholder {
            color: rgba(255,255,255,0.7);
        }
        #search-btn, #locate-btn {
            padding: 0 20px;
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        #search-btn:hover, #locate-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }
        #locate-btn {
            padding: 0 15px;
        }

        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }

        .alert-box {
            background: var(--warn-color);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            animation: pulse 2s infinite;
        }

        .main-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            margin-bottom: 25px;
        }

        .temp-now { font-size: 5rem; font-weight: bold; margin: 10px 0; }
        .temp-now span { font-size: 2rem; vertical-align: top; }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .detail-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }

        .forecast-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .forecast-day {
            background: var(--glass);
            padding: 15px 25px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }

        @media (min-width: 768px) {
            .forecast-list {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 10px;
            }
            .forecast-day {
                flex-direction: column;
                padding: 15px 5px;
                text-align: center;
                font-size: 0.9rem;
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ä¸­å›½AQIæ ‡å‡†é¢œè‰² */
        .aqi-excellent { color: #00e400; font-weight: bold; }       /* ä¼˜ - ç»¿è‰² */
        .aqi-good { color: #ffff00; font-weight: bold; }           /* è‰¯ - é»„è‰² */
        .aqi-light-pollution { color: #ff7e00; font-weight: bold; } /* è½»åº¦æ±¡æŸ“ - æ©™è‰² */
        .aqi-moderate-pollution { color: #ff0000; font-weight: bold; } /* ä¸­åº¦æ±¡æŸ“ - çº¢è‰² */
        .aqi-heavy-pollution { color: #99004c; font-weight: bold; } /* é‡åº¦æ±¡æŸ“ - ç´«è‰² */
        .aqi-severe-pollution { color: #7e0023; font-weight: bold; } /* ä¸¥é‡æ±¡æŸ“ - è¤çº¢è‰² */
        
        /* AQIç­‰çº§æ ‡ç­¾æ ·å¼ */
        .aqi-level {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 5px;
            color: white;
        }
        .aqi-level-excellent { background-color: #00e400; }
        .aqi-level-good { background-color: #ffff00; color: #333; }
        .aqi-level-light { background-color: #ff7e00; }
        .aqi-level-moderate { background-color: #ff0000; }
        .aqi-level-heavy { background-color: #99004c; }
        .aqi-level-severe { background-color: #7e0023; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            animation: pulse 1.5s infinite;
            opacity: 0.7;
        }
        
        /* æœç´¢ç»“æœæ ·å¼ */
        .search-results {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 10px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 100;
            display: none;
        }
        
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* ç©ºæ°”è´¨é‡ä¿¡æ¯æç¤º */
        .aqi-info {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* æ±¡æŸ“ç‰©è¯¦ç»†ä¿¡æ¯ */
        .aqi-breakdown {
            margin-top: 10px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="search-container" style="position: relative;">
        <input type="text" id="city-search" placeholder="è¾“å…¥åŸå¸‚å (å¦‚: åŒ—äº¬, Shanghai)..." autocomplete="off">
        <button id="search-btn" onclick="handleSearch()">ğŸ”</button>
        <button id="locate-btn" onclick="handleLocation()" title="å®šä½å½“å‰ä½ç½®">ğŸ“</button>
        <div id="search-results" class="search-results"></div>
    </div>

    <header>
        <h1 id="city-name">åŠ è½½ä¸­...</h1>
        <p id="date">--</p>
    </header>

    <div id="weather-alert" class="alert-box">
        <strong>âš ï¸ é¢„è­¦ï¼š</strong> <span id="alert-text"></span>
    </div>

    <section class="main-card">
        <div id="condition" style="font-size: 1.5rem;">--</div>
        <div class="temp-now" id="temp-val">--<span>Â°C</span></div>
        <div id="feels-like-container" style="font-size: 1.1rem; opacity: 0.9; margin-bottom: 20px;">ä½“æ„Ÿ <span id="feels-like">--</span>Â°C</div>
        <div class="details-grid">
            <div class="detail-item">
                <p>é™æ°´æ¦‚ç‡</p>
                <p id="pop" style="font-weight: bold;">--%</p>
            </div>
            <div class="detail-item">
                <p>ç©ºæ°”è´¨é‡</p>
                <p id="aqi">--</p>
                <div class="aqi-info" id="aqi-info">æ­£åœ¨è·å–...</div>
            </div>
            <div class="detail-item">
                <p>é£åŠ›</p>
                <p id="wind">--</p>
            </div>
            <div class="detail-item">
                <p>ç›¸å¯¹æ¹¿åº¦</p>
                <p id="humidity">--%</p>
            </div>
        </div>
    </section>

    <h3 style="margin-bottom: 15px;">æœªæ¥7å¤©é¢„æŠ¥</h3>
    <section class="forecast-list" id="forecast-container"></section>
</div>

<script>
// ä¸­å›½åŸå¸‚æ•°æ®åº“
const CITY_DATABASE = [
    { name: "åŒ—äº¬", pinyin: ["beijing", "bei jing"], lat: 39.9042, lon: 116.4074, country: "CN" },
    { name: "ä¸Šæµ·", pinyin: ["shanghai", "shang hai"], lat: 31.2304, lon: 121.4737, country: "CN" },
    { name: "å¹¿å·", pinyin: ["guangzhou", "guang zhou"], lat: 23.1291, lon: 113.2644, country: "CN" },
    { name: "æ·±åœ³", pinyin: ["shenzhen", "shen zhen"], lat: 22.5431, lon: 114.0579, country: "CN" },
    { name: "æˆéƒ½", pinyin: ["chengdu", "cheng du"], lat: 30.5728, lon: 104.0668, country: "CN" },
    { name: "é‡åº†", pinyin: ["chongqing", "chong qing"], lat: 29.4316, lon: 106.9123, country: "CN" },
    { name: "æ­å·", pinyin: ["hangzhou", "hang zhou"], lat: 30.2741, lon: 120.1551, country: "CN" },
    { name: "å—äº¬", pinyin: ["nanjing", "nan jing"], lat: 32.0603, lon: 118.7969, country: "CN" },
    { name: "æ­¦æ±‰", pinyin: ["wuhan", "wu han"], lat: 30.5928, lon: 114.3055, country: "CN" },
    { name: "è¥¿å®‰", pinyin: ["xian", "xi an"], lat: 34.3416, lon: 108.9398, country: "CN" },
    { name: "å¤©æ´¥", pinyin: ["tianjin", "tian jin"], lat: 39.3434, lon: 117.3616, country: "CN" }
];

let currentCity = { 
    name: "åŒ—äº¬", 
    lat: 39.9042, 
    lon: 116.4074,
    timezone: "Asia/Shanghai"
};

let debounceTimer;
const searchInput = document.getElementById('city-search');
const searchResults = document.getElementById('search-results');

// è¾“å…¥ç›‘å¬
searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();
    
    if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
    }
    
    debounceTimer = setTimeout(() => {
        searchCities(query);
    }, 300);
});

// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æœç´¢ç»“æœ
document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
    }
});

// æœç´¢åŸå¸‚
function searchCities(query) {
    const results = [];
    const lowerQuery = query.toLowerCase().replace(/\s+/g, '');
    
    CITY_DATABASE.forEach(city => {
        if (city.name.includes(query)) {
            results.push({
                name: city.name,
                lat: city.lat,
                lon: city.lon,
                country: city.country,
                matchType: 'ä¸­æ–‡'
            });
            return;
        }
        
        for (const pinyin of city.pinyin) {
            const cleanPinyin = pinyin.replace(/\s+/g, '');
            if (cleanPinyin.includes(lowerQuery) || lowerQuery.includes(cleanPinyin)) {
                results.push({
                    name: city.name,
                    lat: city.lat,
                    lon: city.lon,
                    country: city.country,
                    matchType: 'æ‹¼éŸ³'
                });
                return;
            }
        }
    });
    
    displaySearchResults(results);
}

// æ˜¾ç¤ºæœç´¢ç»“æœ
function displaySearchResults(results) {
    searchResults.innerHTML = '';
    
    if (results.length === 0) {
        searchResults.style.display = 'none';
        return;
    }
    
    const displayResults = results.slice(0, 10);
    
    displayResults.forEach(result => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        
        let flag = '';
        switch(result.country) {
            case 'CN': flag = 'ğŸ‡¨ğŸ‡³'; break;
            default: flag = 'ğŸŒ';
        }
        
        item.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span style="font-size: 1.2rem;">${flag}</span>
                    <span style="font-weight: bold; margin-left: 8px;">${result.name}</span>
                </div>
                <span style="font-size: 0.8rem; opacity: 0.7;">${result.matchType}</span>
            </div>
        `;
        
        item.addEventListener('click', () => {
            currentCity = {
                name: result.name,
                lat: result.lat,
                lon: result.lon,
                timezone: result.country === 'CN' ? 'Asia/Shanghai' : 'auto'
            };
            
            searchInput.value = result.name;
            searchResults.style.display = 'none';
            fetchWeather();
        });
        
        searchResults.appendChild(item);
    });
    
    searchResults.style.display = 'block';
}

// æœç´¢æŒ‰é’®ç‚¹å‡»
function handleSearch() {
    const query = searchInput.value.trim();
    
    if (!query) {
        alert('è¯·è¾“å…¥åŸå¸‚å');
        return;
    }
    
    const btn = document.getElementById('search-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading">â³</span>';
    
    let found = false;
    const lowerQuery = query.toLowerCase().replace(/\s+/g, '');
    
    for (const city of CITY_DATABASE) {
        if (city.name === query) {
            selectCity(city);
            found = true;
            break;
        }
        
        for (const pinyin of city.pinyin) {
            const cleanPinyin = pinyin.replace(/\s+/g, '');
            if (cleanPinyin === lowerQuery) {
                selectCity(city);
                found = true;
                break;
            }
        }
        
        if (found) break;
    }
    
    if (!found) {
        searchByAPI(query);
    } else {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”';
    }
}

// é€‰æ‹©åŸå¸‚
function selectCity(city) {
    currentCity = {
        name: city.name,
        lat: city.lat,
        lon: city.lon,
        timezone: city.country === 'CN' ? 'Asia/Shanghai' : 'auto'
    };
    
    searchInput.value = city.name;
    searchResults.style.display = 'none';
    fetchWeather();
}

// ä½¿ç”¨APIæœç´¢
async function searchByAPI(query) {
    try {
        const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=zh&format=json`;
        const res = await fetch(url).then(r => r.json());
        
        if (res.results && res.results.length > 0) {
            const result = res.results[0];
            currentCity = {
                name: result.name,
                lat: result.latitude,
                lon: result.longitude,
                timezone: result.timezone || "auto"
            };
            
            fetchWeather();
        } else {
            alert('æœªæ‰¾åˆ°è¯¥åŸå¸‚ï¼Œè¯·å°è¯•å…¶ä»–åç§°');
        }
    } catch (err) {
        console.error("æœç´¢å¤±è´¥:", err);
        alert("æœç´¢æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
    } finally {
        const btn = document.getElementById('search-btn');
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”';
    }
}

// è·å–å®šä½
function handleLocation() {
    const btn = document.getElementById('locate-btn');
    
    if (!navigator.geolocation) {
        alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½");
        return;
    }

    btn.style.transform = "scale(0.9)";
    
    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const { latitude, longitude } = position.coords;
            
            try {
                const reverseUrl = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${latitude}&longitude=${longitude}&language=zh`;
                const res = await fetch(reverseUrl).then(r => r.json());
                
                let cityName = "æˆ‘çš„ä½ç½®";
                if (res.results && res.results.length > 0) {
                    const city = res.results[0];
                    cityName = city.name || "å½“å‰ä½ç½®";
                }
                
                currentCity = {
                    name: cityName,
                    lat: latitude,
                    lon: longitude,
                    timezone: "auto"
                };
                
                fetchWeather();
            } catch (error) {
                currentCity = {
                    name: "æˆ‘çš„ä½ç½®",
                    lat: latitude,
                    lon: longitude,
                    timezone: "auto"
                };
                fetchWeather();
            }
            
            btn.style.transform = "scale(1)";
        },
        (error) => {
            console.error("å®šä½å¤±è´¥:", error);
            alert(error.code === 1 ? "è¯·å…è®¸è·å–ä½ç½®ä¿¡æ¯" : "å®šä½å¤±è´¥");
            btn.style.transform = "scale(1)";
        },
        { 
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// è·å–å¤©æ°”æ•°æ®
async function fetchWeather() {
    try {
        const { lat, lon, timezone } = currentCity;
        
        document.getElementById('city-name').innerHTML = `${currentCity.name} <span class="loading">...</span>`;
        document.getElementById('aqi-info').innerText = 'æ­£åœ¨è·å–...';
        
        // å¤©æ°”API
        const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&hourly=precipitation_probability&timezone=${timezone}`;
        
        // ç©ºæ°”è´¨é‡API - ä½¿ç”¨waqi.infoçš„å¼€æ”¾APIï¼ˆéœ€è¦API Keyï¼‰
        // ç”±äºéœ€è¦API Keyï¼Œè¿™é‡Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼šæ¨¡æ‹Ÿæ•°æ® + åˆç†ä¼°ç®—
        // å®é™…åº”ç”¨ä¸­ï¼Œæ‚¨éœ€è¦æ³¨å†Œwaqi.infoè·å–API Key
        const aqiData = await fetchAQIData(lat, lon);
        
        const weatherRes = await fetch(weatherUrl).then(res => res.json());
        
        updateUI(weatherRes, aqiData);
        
    } catch (err) {
        console.error("è·å–å¤©æ°”æ•°æ®å¤±è´¥:", err);
        document.getElementById('city-name').innerText = currentCity.name;
        document.getElementById('aqi-info').innerText = 'æ•°æ®è·å–å¤±è´¥';
        alert("æ— æ³•è·å–å¤©æ°”æ•°æ®ï¼Œè¯·ç¨åå†è¯•");
    }
}

// è·å–AQIæ•°æ®ï¼ˆæ¨¡æ‹Ÿå®ç°ï¼Œå®é™…éœ€è¦API Keyï¼‰
async function fetchAQIData(lat, lon) {
    // æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå‡½æ•°ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„AQI API
    // è¿™é‡Œä½¿ç”¨ç®€å•çš„ä¼°ç®—é€»è¾‘
    
    try {
        // å°è¯•ä½¿ç”¨OpenAQ APIï¼ˆå…è´¹ã€å…¬å¼€çš„ç©ºæ°”è´¨é‡æ•°æ®ï¼‰
        const openAQUrl = `https://api.openaq.org/v2/latest?coordinates=${lat},${lon}&radius=50000&limit=1`;
        
        const response = await fetch(openAQUrl);
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
                const measurements = data.results[0].measurements;
                
                // æå–æ±¡æŸ“ç‰©æ•°æ®
                let pm25 = 0, pm10 = 0, no2 = 0, so2 = 0, o3 = 0, co = 0;
                
                measurements.forEach(m => {
                    switch(m.parameter) {
                        case 'pm25': pm25 = m.value; break;
                        case 'pm10': pm10 = m.value; break;
                        case 'no2': no2 = m.value; break;
                        case 'so2': so2 = m.value; break;
                        case 'o3': o3 = m.value; break;
                        case 'co': co = m.value; break;
                    }
                });
                
                return {
                    pm25: pm25,
                    pm10: pm10,
                    no2: no2,
                    so2: so2,
                    o3: o3,
                    co: co,
                    source: 'OpenAQ'
                };
            }
        }
    } catch (err) {
        console.log('OpenAQ APIå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', err);
    }
    
    // å¤‡ç”¨æ–¹æ¡ˆï¼šåŸºäºå…¸å‹åŸå¸‚å’Œæ—¶é—´çš„æ¨¡æ‹Ÿæ•°æ®
    // è¿™åªæ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œå®é™…å€¼åº”è¯¥ä»å¯é APIè·å–
    return generateSimulatedAQI(lat, lon);
}

// ç”Ÿæˆæ¨¡æ‹ŸAQIæ•°æ®ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
function generateSimulatedAQI(lat, lon) {
    // è·å–å½“å‰æ—¶é—´
    const now = new Date();
    const hour = now.getHours();
    const month = now.getMonth() + 1; // 1-12æœˆ
    
    // åŸºç¡€å€¼ï¼Œæ¨¡æ‹Ÿä¸åŒåŸå¸‚
    let basePM25 = 20; // é»˜è®¤20 Î¼g/mÂ³
    
    // æ ¹æ®åœ°ç†ä½ç½®è°ƒæ•´
    if (Math.abs(lat - 39.9) < 2 && Math.abs(lon - 116.4) < 2) { // åŒ—äº¬é™„è¿‘
        basePM25 = 35;
    } else if (Math.abs(lat - 31.2) < 2 && Math.abs(lon - 121.5) < 2) { // ä¸Šæµ·é™„è¿‘
        basePM25 = 25;
    } else if (Math.abs(lat - 23.1) < 2 && Math.abs(lon - 113.3) < 2) { // å¹¿å·é™„è¿‘
        basePM25 = 30;
    } else if (Math.abs(lat - 30.6) < 2 && Math.abs(lon - 104.1) < 2) { // æˆéƒ½é™„è¿‘
        basePM25 = 40;
    }
    
    // æ ¹æ®å­£èŠ‚è°ƒæ•´ï¼ˆå†¬å­£æ±¡æŸ“é€šå¸¸æ›´ä¸¥é‡ï¼‰
    if (month >= 11 || month <= 2) { // å†¬å­£
        basePM25 *= 1.5;
    } else if (month >= 3 && month <= 5) { // æ˜¥å­£
        basePM25 *= 1.2;
    } else if (month >= 6 && month <= 8) { // å¤å­£
        basePM25 *= 0.8;
    } else { // ç§‹å­£
        basePM25 *= 1.0;
    }
    
    // æ ¹æ®ä¸€å¤©ä¸­çš„æ—¶é—´è°ƒæ•´ï¼ˆæ—©æ™šé«˜å³°æ›´ä¸¥é‡ï¼‰
    if (hour >= 7 && hour <= 9) { // æ—©é«˜å³°
        basePM25 *= 1.2;
    } else if (hour >= 17 && hour <= 19) { // æ™šé«˜å³°
        basePM25 *= 1.1;
    } else if (hour >= 22 || hour <= 5) { // å¤œé—´
        basePM25 *= 0.9;
    }
    
    // æ·»åŠ ä¸€äº›éšæœºæ³¢åŠ¨ï¼ˆÂ±15%ï¼‰
    const variation = 0.85 + Math.random() * 0.3; // 0.85-1.15
    basePM25 *= variation;
    
    // ç”Ÿæˆå…¶ä»–æ±¡æŸ“ç‰©æ•°æ®ï¼ˆåŸºäºPM2.5çš„æ¯”ä¾‹ï¼‰
    return {
        pm25: Math.round(basePM25 * 10) / 10,
        pm10: Math.round(basePM25 * 1.5 * 10) / 10, // PM10é€šå¸¸æ¯”PM2.5é«˜
        no2: Math.round(basePM25 * 0.7 * 10) / 10,
        so2: Math.round(basePM25 * 0.3 * 10) / 10,
        o3: Math.round(basePM25 * 0.5 * 10) / 10,
        co: Math.round(basePM25 * 0.1 * 10) / 10,
        source: 'æ¨¡æ‹Ÿæ•°æ®'
    };
}

// æ ¹æ®ä¸­å›½æ ‡å‡†è®¡ç®—AQI (HJ 633-2012)
function calculateChinaAQI(pollutants) {
    // æ±¡æŸ“ç‰©æµ“åº¦é™å€¼è¡¨ (24å°æ—¶å¹³å‡ï¼Œå•ä½: Î¼g/mÂ³, COä¸ºmg/mÂ³)
    // æ ¹æ®ã€Šç¯å¢ƒç©ºæ°”è´¨é‡æŒ‡æ•°(AQI)æŠ€æœ¯è§„å®š(è¯•è¡Œ)ã€‹(HJ 633-2012)
    const AQI_TABLE = {
        // PM2.5 (24å°æ—¶å¹³å‡, Î¼g/mÂ³)
        'PM2.5': [
            [0, 35, 50],      // ä¼˜
            [35, 75, 100],    // è‰¯
            [75, 115, 150],   // è½»åº¦æ±¡æŸ“
            [115, 150, 200],  // ä¸­åº¦æ±¡æŸ“
            [150, 250, 300],  // é‡åº¦æ±¡æŸ“
            [250, 350, 400],  // ä¸¥é‡æ±¡æŸ“
            [350, 500, 500]   // ä¸Šé™
        ],
        // PM10 (24å°æ—¶å¹³å‡, Î¼g/mÂ³)
        'PM10': [
            [0, 50, 50],      // ä¼˜
            [50, 150, 100],   // è‰¯
            [150, 250, 150],  // è½»åº¦æ±¡æŸ“
            [250, 350, 200],  // ä¸­åº¦æ±¡æŸ“
            [350, 420, 300],  // é‡åº¦æ±¡æŸ“
            [420, 500, 400],  // ä¸¥é‡æ±¡æŸ“
            [500, 600, 500]   // ä¸Šé™
        ],
        // SO2 (24å°æ—¶å¹³å‡, Î¼g/mÂ³)
        'SO2': [
            [0, 50, 50],      // ä¼˜
            [50, 150, 100],   // è‰¯
            [150, 475, 150],  // è½»åº¦æ±¡æŸ“
            [475, 800, 200],  // ä¸­åº¦æ±¡æŸ“
            [800, 1600, 300], // é‡åº¦æ±¡æŸ“
            [1600, 2100, 400],// ä¸¥é‡æ±¡æŸ“
            [2100, 2620, 500] // ä¸Šé™
        ],
        // NO2 (24å°æ—¶å¹³å‡, Î¼g/mÂ³)
        'NO2': [
            [0, 40, 50],      // ä¼˜
            [40, 80, 100],    // è‰¯
            [80, 180, 150],   // è½»åº¦æ±¡æŸ“
            [180, 280, 200],  // ä¸­åº¦æ±¡æŸ“
            [280, 565, 300],  // é‡åº¦æ±¡æŸ“
            [565, 750, 400],  // ä¸¥é‡æ±¡æŸ“
            [750, 940, 500]   // ä¸Šé™
        ],
        // O3 (æ—¥æœ€å¤§8å°æ—¶å¹³å‡, Î¼g/mÂ³)
        'O3_8h': [
            [0, 100, 50],     // ä¼˜
            [100, 160, 100],  // è‰¯
            [160, 215, 150],  // è½»åº¦æ±¡æŸ“
            [215, 265, 200],  // ä¸­åº¦æ±¡æŸ“
            [265, 800, 300],  // é‡åº¦æ±¡æŸ“
            [800, 1000, 400], // ä¸¥é‡æ±¡æŸ“
            [1000, 1200, 500] // ä¸Šé™
        ],
        // CO (24å°æ—¶å¹³å‡, mg/mÂ³)
        'CO': [
            [0, 2, 50],       // ä¼˜
            [2, 4, 100],      // è‰¯
            [4, 14, 150],     // è½»åº¦æ±¡æŸ“
            [14, 24, 200],    // ä¸­åº¦æ±¡æŸ“
            [24, 36, 300],    // é‡åº¦æ±¡æŸ“
            [36, 48, 400],    // ä¸¥é‡æ±¡æŸ“
            [48, 60, 500]     // ä¸Šé™
        ]
    };

    // æ±¡æŸ“ç‰©æ˜ å°„
    const pollutantMap = {
        'pm25': { name: 'PM2.5', value: Math.max(0, pollutants.pm25 || 0) },
        'pm10': { name: 'PM10', value: Math.max(0, pollutants.pm10 || 0) },
        'so2': { name: 'SO2', value: Math.max(0, pollutants.so2 || 0) },
        'no2': { name: 'NO2', value: Math.max(0, pollutants.no2 || 0) },
        'o3': { name: 'O3_8h', value: Math.max(0, pollutants.o3 || 0) },
        'co': { name: 'CO', value: Math.max(0, (pollutants.co || 0) / 1000) } // Î¼g/mÂ³ è½¬ mg/mÂ³
    };

    let maxAQI = 0;
    let primaryPollutant = '';
    const pollutantResults = [];

    // è®¡ç®—æ¯ä¸ªæ±¡æŸ“ç‰©çš„IAQI
    for (const [key, data] of Object.entries(pollutantMap)) {
        const pollutantName = data.name;
        let concentration = data.value;
        
        // å¦‚æœæµ“åº¦æ˜¯0ï¼Œè·³è¿‡è®¡ç®—
        if (concentration <= 0) continue;
        
        // è·å–è¯¥æ±¡æŸ“ç‰©çš„AQIè¡¨
        const aqiRanges = AQI_TABLE[pollutantName];
        if (!aqiRanges) continue;
        
        // æ‰¾åˆ°æµ“åº¦æ‰€åœ¨çš„åŒºé—´
        let iaqi = 0;
        for (let i = 0; i < aqiRanges.length; i++) {
            const range = aqiRanges[i];
            const [lowConc, highConc, highAQI] = range;
            
            if (concentration >= lowConc && concentration <= highConc) {
                // å‰ä¸€ä¸ªèŒƒå›´çš„AQIå€¼
                const prevRange = i > 0 ? aqiRanges[i-1] : [0, lowConc, 0];
                const lowAQI = prevRange[2];
                
                // çº¿æ€§æ’å€¼è®¡ç®—IAQI
                iaqi = Math.round(
                    lowAQI + (highAQI - lowAQI) * (concentration - lowConc) / (highConc - lowConc)
                );
                break;
            }
            
            // å¦‚æœæµ“åº¦è¶…è¿‡æœ€å¤§å€¼ï¼Œå–æœ€å¤§å€¼500
            if (concentration > highConc && i === aqiRanges.length - 1) {
                iaqi = 500;
                break;
            }
        }
        
        // ç¡®ä¿IAQIåœ¨æœ‰æ•ˆèŒƒå›´å†…
        iaqi = Math.min(Math.max(iaqi, 0), 500);
        
        pollutantResults.push({
            name: pollutantName,
            value: concentration,
            iaqi: iaqi,
            unit: pollutantName === 'CO' ? 'mg/mÂ³' : 'Î¼g/mÂ³'
        });
        
        // æ›´æ–°æœ€å¤§AQI
        if (iaqi > maxAQI) {
            maxAQI = iaqi;
            primaryPollutant = pollutantName;
        }
    }

    // å¦‚æœæ‰€æœ‰æ±¡æŸ“ç‰©éƒ½æ˜¯0ï¼Œåˆ™AQIä¸º0ï¼ˆç†è®ºä¸Šä¸ä¼šå‡ºç°ï¼‰
    if (maxAQI === 0 && pollutantResults.length === 0) {
        maxAQI = 25; // é»˜è®¤è‰¯å¥½ç©ºæ°”è´¨é‡
    }

    // ç¡®å®šAQIç­‰çº§å’Œæè¿°
    let aqiLevel, aqiDesc, healthImpact, className;
    
    if (maxAQI <= 50) {
        aqiLevel = "ä¼˜";
        aqiDesc = "ç©ºæ°”è´¨é‡ä»¤äººæ»¡æ„";
        healthImpact = "å„ç±»äººç¾¤å¯æ­£å¸¸æ´»åŠ¨";
        className = "aqi-excellent";
    } else if (maxAQI <= 100) {
        aqiLevel = "è‰¯";
        aqiDesc = "ç©ºæ°”è´¨é‡å¯æ¥å—";
        healthImpact = "æå°‘æ•°å¼‚å¸¸æ•æ„Ÿäººç¾¤åº”å‡å°‘æˆ·å¤–æ´»åŠ¨";
        className = "aqi-good";
    } else if (maxAQI <= 150) {
        aqiLevel = "è½»åº¦æ±¡æŸ“";
        aqiDesc = "æ˜“æ„Ÿäººç¾¤ç—‡çŠ¶æœ‰è½»åº¦åŠ å‰§";
        healthImpact = "å„¿ç«¥ã€è€å¹´äººåŠå¿ƒè„ç—…ã€å‘¼å¸ç³»ç»Ÿç–¾ç—…æ‚£è€…åº”å‡å°‘é•¿æ—¶é—´ã€é«˜å¼ºåº¦çš„æˆ·å¤–é”»ç‚¼";
        className = "aqi-light-pollution";
    } else if (maxAQI <= 200) {
        aqiLevel = "ä¸­åº¦æ±¡æŸ“";
        aqiDesc = "è¿›ä¸€æ­¥åŠ å‰§æ˜“æ„Ÿäººç¾¤ç—‡çŠ¶";
        healthImpact = "å„¿ç«¥ã€è€å¹´äººåŠå¿ƒè„ç—…ã€å‘¼å¸ç³»ç»Ÿç–¾ç—…æ‚£è€…é¿å…é•¿æ—¶é—´ã€é«˜å¼ºåº¦çš„æˆ·å¤–é”»ç‚¼";
        className = "aqi-moderate-pollution";
    } else if (maxAQI <= 300) {
        aqiLevel = "é‡åº¦æ±¡æŸ“";
        aqiDesc = "å¿ƒè„ç—…å’Œè‚ºç—…æ‚£è€…ç—‡çŠ¶æ˜¾è‘—åŠ å‰§";
        healthImpact = "å„¿ç«¥ã€è€å¹´äººå’Œå¿ƒè„ç—…ã€è‚ºç—…æ‚£è€…åº”åœç•™åœ¨å®¤å†…ï¼Œåœæ­¢æˆ·å¤–è¿åŠ¨";
        className = "aqi-heavy-pollution";
    } else {
        aqiLevel = "ä¸¥é‡æ±¡æŸ“";
        aqiDesc = "å¥åº·äººç¾¤è¿åŠ¨è€å—åŠ›é™ä½";
        healthImpact = "å„¿ç«¥ã€è€å¹´äººå’Œç—…äººåº”å½“ç•™åœ¨å®¤å†…ï¼Œé¿å…ä½“åŠ›æ¶ˆè€—ï¼Œä¸€èˆ¬äººç¾¤åº”é¿å…æˆ·å¤–æ´»åŠ¨";
        className = "aqi-severe-pollution";
    }

    return {
        aqi: maxAQI,
        level: aqiLevel,
        description: aqiDesc,
        healthImpact: healthImpact,
        className: className,
        primaryPollutant: primaryPollutant,
        pollutants: pollutantResults,
        source: pollutants.source || 'æœªçŸ¥æ¥æº'
    };
}

// æ›´æ–°UI
function updateUI(weather, airData) {
    // æ›´æ–°æ—¥æœŸ
    const now = new Date();
    document.getElementById('date').innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
    
    // æ›´æ–°åŸå¸‚å
    document.getElementById('city-name').innerText = currentCity.name;
    
    // æ›´æ–°å½“å‰å¤©æ°”
    if (weather.current) {
        const current = weather.current;
        document.getElementById('temp-val').innerHTML = `${Math.round(current.temperature_2m)}<span>Â°C</span>`;
        document.getElementById('feels-like').innerText = Math.round(current.apparent_temperature);
        document.getElementById('condition').innerText = getWeatherText(current.weather_code);
        document.getElementById('wind').innerText = `${getWindDirection(current.wind_direction_10m)} ${Math.round(current.wind_speed_10m)}km/h`;
        document.getElementById('humidity').innerText = `${current.relative_humidity_2m}%`;
    }
    
    // æ›´æ–°é™æ°´æ¦‚ç‡
    if (weather.hourly && weather.hourly.precipitation_probability) {
        const currentHour = new Date().getHours();
        const popIndex = weather.hourly.time.findIndex(time => {
            const hour = new Date(time).getHours();
            return hour === currentHour;
        });
        
        if (popIndex !== -1) {
            const popValue = weather.hourly.precipitation_probability[popIndex];
            document.getElementById('pop').innerText = `${popValue}%`;
        }
    }
    
    // æ›´æ–°ç©ºæ°”è´¨é‡ï¼ˆä¸­å›½æ ‡å‡†ï¼‰
    const aqiEl = document.getElementById('aqi');
    const aqiInfoEl = document.getElementById('aqi-info');
    
    if (airData) {
        // è®¡ç®—ä¸­å›½æ ‡å‡†AQI
        const chinaAQI = calculateChinaAQI(airData);
        
        // æ˜¾ç¤ºAQIå€¼å’Œç­‰çº§
        aqiEl.innerHTML = `
            ${chinaAQI.aqi} 
            <span class="aqi-level aqi-level-${chinaAQI.level === 'ä¼˜' ? 'excellent' : 
                                           chinaAQI.level === 'è‰¯' ? 'good' : 
                                           chinaAQI.level === 'è½»åº¦æ±¡æŸ“' ? 'light' :
                                           chinaAQI.level === 'ä¸­åº¦æ±¡æŸ“' ? 'moderate' :
                                           chinaAQI.level === 'é‡åº¦æ±¡æŸ“' ? 'heavy' : 'severe'}">
                ${chinaAQI.level}
            </span>
        `;
        
        // è®¾ç½®é¢œè‰²ç±»
        aqiEl.className = '';
        aqiEl.classList.add(chinaAQI.className);
        
        // æ˜¾ç¤ºç©ºæ°”è´¨é‡ä¿¡æ¯
        aqiInfoEl.innerHTML = `
            ${chinaAQI.description}
            ${chinaAQI.source === 'æ¨¡æ‹Ÿæ•°æ®' ? '<br><small>(æ¨¡æ‹Ÿæ•°æ®ï¼Œä»…ä¾›å‚è€ƒ)</small>' : ''}
        `;
        
        // å­˜å‚¨AQIæ•°æ®
        window.currentAQIData = chinaAQI;
    } else {
        aqiEl.innerText = "æ— æ•°æ®";
        aqiInfoEl.innerText = "ç©ºæ°”è´¨é‡æ•°æ®æš‚æ—¶ä¸å¯ç”¨";
        window.currentAQIData = null;
    }
    
    // æ›´æ–°é¢„è­¦ä¿¡æ¯
    document.getElementById('weather-alert').style.display = 'none';
    
    // æ›´æ–°7å¤©é¢„æŠ¥
    const forecastContainer = document.getElementById('forecast-container');
    forecastContainer.innerHTML = '';
    
    if (weather.daily && weather.daily.time) {
        const { time, weather_code, temperature_2m_max, temperature_2m_min, precipitation_probability_max } = weather.daily;
        
        for (let i = 0; i < Math.min(7, time.length); i++) {
            const dateObj = new Date(time[i]);
            const dayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
            
            const div = document.createElement('div');
            div.className = 'forecast-day';
            
            const today = new Date();
            const isToday = dateObj.getDate() === today.getDate() && 
                           dateObj.getMonth() === today.getMonth() && 
                           dateObj.getFullYear() === today.getFullYear();
            
            div.innerHTML = `
                <span style="font-weight:bold">${isToday ? 'ä»Šå¤©' : dayNames[dateObj.getDay()]}</span>
                <span style="font-size:0.8rem; opacity:0.8">${(dateObj.getMonth()+1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')}</span>
                <span style="font-size:1.2rem">${getWeatherIcon(weather_code[i])}</span>
                <span style="font-size:0.8rem; color:#87ceeb">ğŸ’§${precipitation_probability_max[i]}%</span>
                <span style="font-weight:500">${Math.round(temperature_2m_min[i])}Â°/${Math.round(temperature_2m_max[i])}Â°</span>
            `;
            forecastContainer.appendChild(div);
        }
    }
}

// è¾…åŠ©å‡½æ•°
function getWeatherText(code) {
    const weatherCodes = {
        0: "æ™´å¤©", 1: "æ™´ï¼Œå°‘é‡äº‘", 2: "å±€éƒ¨å¤šäº‘", 3: "å¤šäº‘",
        45: "æœ‰é›¾", 48: "æœ‰é›¾", 51: "æ¯›æ¯›é›¨", 53: "ç»†é›¨",
        55: "å¯†é›†ç»†é›¨", 56: "å†»æ¯›æ¯›é›¨", 57: "å¯†é›†å†»æ¯›æ¯›é›¨",
        61: "å°é›¨", 63: "ä¸­é›¨", 65: "å¤§é›¨", 66: "å†»é›¨",
        67: "å¯†é›†å†»é›¨", 71: "å°é›ª", 73: "ä¸­é›ª", 75: "å¤§é›ª",
        77: "å†°é›¹", 80: "é˜µé›¨", 81: "å¼ºé˜µé›¨", 82: "æš´é›¨",
        85: "é˜µé›ª", 86: "å¼ºé˜µé›ª", 95: "é›·æš´", 96: "é›·æš´ä¼´å†°é›¹",
        99: "å¼ºé›·æš´ä¼´å†°é›¹"
    };
    return weatherCodes[code] || "æœªçŸ¥å¤©æ°”";
}

function getWeatherIcon(code) {
    if (code === 0) return "â˜€ï¸";
    if (code <= 3) return "ğŸŒ¤ï¸";
    if (code <= 48) return "ğŸŒ«ï¸";
    if (code <= 57) return "ğŸŒ§ï¸";
    if (code <= 67) return "ğŸŒ§ï¸";
    if (code <= 77) return "â„ï¸";
    if (code <= 82) return "ğŸŒ§ï¸";
    if (code <= 86) return "â„ï¸";
    if (code <= 99) return "â›ˆï¸";
    return "ğŸŒ¡ï¸";
}

function getWindDirection(degrees) {
    const directions = ["åŒ—", "ä¸œåŒ—", "ä¸œ", "ä¸œå—", "å—", "è¥¿å—", "è¥¿", "è¥¿åŒ—"];
    const index = Math.round(degrees / 45) % 8;
    return directions[index] || "";
}

// é¡µé¢åŠ è½½æ—¶è·å–å¤©æ°”
window.onload = () => {
    fetchWeather();
};
</script>
</body>
</html>
