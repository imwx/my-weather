<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å¤©æ°”é¢„æŠ¥</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass: rgba(255, 255, 255, 0.2);
            --text-main: #ffffff;
            --warn-color: #ff4d4d;
            --active-city: rgba(255, 255, 255, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
        }

        /* åŸå¸‚åˆ‡æ¢å¯¼èˆª */
        .city-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .city-btn {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
        }
        .city-btn.active {
            background: var(--active-city);
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }

        .alert-box {
            background: var(--warn-color);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            animation: pulse 2s infinite;
        }

        .main-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            margin-bottom: 25px;
        }

        .temp-now { font-size: 5rem; font-weight: bold; margin: 10px 0; }
        .temp-now span { font-size: 2rem; vertical-align: top; }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .detail-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }

        .forecast-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .forecast-day {
            background: var(--glass);
            padding: 15px 25px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }

        @media (min-width: 768px) {
            .forecast-list {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 10px;
            }
            .forecast-day {
                flex-direction: column;
                padding: 15px 5px;
                text-align: center;
                font-size: 0.9rem;
            }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .aqi-good { color: #52c41a; font-weight: bold; }
        .aqi-mid { color: #faad14; font-weight: bold; }
        .aqi-bad { color: #ff4d4d; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="city-tabs" id="city-tabs">
        </div>

    <header>
        <h1 id="city-name">åŠ è½½ä¸­...</h1>
        <p id="date">--</p>
    </header>

    <div id="weather-alert" class="alert-box">
        <strong>âš ï¸ é¢„è­¦ï¼š</strong> <span id="alert-text"></span>
    </div>

    <section class="main-card">
        <div id="condition" style="font-size: 1.5rem;">--</div>
        <div class="temp-now" id="temp-val">--<span>Â°C</span></div>
        <div class="details-grid">
            <div class="detail-item">
                <p>é™æ°´æ¦‚ç‡</p>
                <p id="pop" style="font-weight: bold;">--%</p>
            </div>
            <div class="detail-item">
                <p>ç©ºæ°”è´¨é‡</p>
                <p id="aqi">--</p>
            </div>
            <div class="detail-item">
                <p>é£åŠ›æé†’</p>
                <p id="wind">--</p>
            </div>
            <div class="detail-item">
                <p>ç›¸å¯¹æ¹¿åº¦</p>
                <p id="humidity">--%</p>
            </div>
        </div>
    </section>

    <h3 style="margin-bottom: 15px;">æœªæ¥7å¤©é¢„æŠ¥</h3>
    <section class="forecast-list" id="forecast-container"></section>
</div>

<script>
// 1. é…ç½®ä¿¡æ¯
const API_KEY = "793c97a29e61493782d3780951d83c05"; 
const BASE_URL = "https://n36hextae3.re.qweatherapi.com/v7";

// åŸå¸‚æ•°æ®é…ç½®ï¼ˆå¢åŠ ç»çº¬åº¦ç”¨äºè·å–å…è´¹ç©ºæ°”è´¨é‡ï¼‰
const CITIES = [
    { name: "ä¸Šæµ·", id: "101020100", lat: 31.2304, lon: 121.4737 },
    { name: "åŒ—äº¬", id: "101010100", lat: 39.9042, lon: 116.4074 },
    { name: "é‡‘å›", id: "101191103", lat: 31.7404, lon: 119.5705 }
];

let currentCityId = CITIES[0].id;

// åˆå§‹åŒ–åŸå¸‚åˆ‡æ¢æŒ‰é’®
function initCityTabs() {
    const container = document.getElementById('city-tabs');
    CITIES.forEach(city => {
        const btn = document.createElement('button');
        btn.className = `city-btn ${city.id === currentCityId ? 'active' : ''}`;
        btn.innerText = city.name;
        btn.onclick = () => switchCity(city.id, btn);
        container.appendChild(btn);
    });
}

function switchCity(cityId, btnElement) {
    currentCityId = cityId;
    // æ›´æ–°æŒ‰é’®æ ·å¼
    document.querySelectorAll('.city-btn').forEach(b => b.classList.remove('active'));
    btnElement.classList.add('active');
    // é‡æ–°æŠ“å–æ•°æ®
    fetchWeather();
}

async function fetchWeather() {
    try {
        // è·å–å½“å‰åŸå¸‚å¯¹è±¡
        const city = CITIES.find(c => c.id === currentCityId);

        const urls = {
            now: `${BASE_URL}/weather/now?location=${currentCityId}&key=${API_KEY}`,
            // ä½¿ç”¨ Open-Meteo å…è´¹å¤©æ°”é¢„æŠ¥ API (å«é™æ°´æ¦‚ç‡ã€7å¤©é¢„æŠ¥)
            daily: `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=auto`,
            // ä½¿ç”¨ Open-Meteo å…è´¹ç©ºæ°”è´¨é‡ API (æ— éœ€Key)
            air: `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${city.lat}&longitude=${city.lon}&current=us_aqi,pm2_5`,
            warn: `${BASE_URL}/warning/now?location=${currentCityId}&key=${API_KEY}`
        };

        const [nowRes, dailyRes, airRes, warnRes] = await Promise.all([
            fetch(urls.now).then(res => res.json()),
            fetch(urls.daily).then(res => res.json()),
            fetch(urls.air).then(res => res.json()),
            fetch(urls.warn).then(res => res.json())
        ]);

        // åªè¦å®æ—¶å¤©æ°”æˆåŠŸå³å¯æ›´æ–°ï¼Œå…¶ä»–æ•°æ®å¦‚æœæ²¡æœ‰ä¼šé™çº§å¤„ç†
        if (nowRes.code === "200") {
            updateUI(nowRes, dailyRes, airRes, warnRes);
        }
    } catch (err) {
        console.error("è¯·æ±‚å¤±è´¥:", err);
    }
}

function updateUI(now, daily, air, warn) {
    // è·å–å½“å‰åŸå¸‚åç§°
    const city = CITIES.find(c => c.id === currentCityId);
    document.getElementById('city-name').innerText = city.name;

    // 1. æ›´æ–°å®æ—¶æ•°æ®
    document.getElementById('temp-val').innerHTML = `${now.now.temp}<span>Â°C</span>`;
    document.getElementById('condition').innerText = now.now.text;
    document.getElementById('wind').innerText = `${now.now.windDir}${now.now.windScale}çº§`;
    document.getElementById('humidity').innerText = `${now.now.humidity}%`;
    
    // é™æ°´æ¦‚ç‡ï¼ˆå–è‡ª Open-Meteo ä»Šæ—¥é¢„æŠ¥ï¼‰
    if (daily && daily.daily && daily.daily.precipitation_probability_max) {
        const todayPop = daily.daily.precipitation_probability_max[0];
        document.getElementById('pop').innerText = `${todayPop}%`;
    }

    // 2. ç©ºæ°”è´¨é‡ (é€‚é… Open-Meteo æ•°æ®ç»“æ„)
    const aqiEl = document.getElementById('aqi');
    
    // æ£€æŸ¥ Open-Meteo è¿”å›ç»“æ„ (current.us_aqi)
    if (air && air.current && air.current.us_aqi !== undefined) {
        const aqiVal = air.current.us_aqi;
        
        // è®¡ç®—ç­‰çº§æè¿°
        let category = "ä¼˜";
        if (aqiVal > 50) category = "è‰¯";
        if (aqiVal > 100) category = "è½»åº¦æ±¡æŸ“";
        if (aqiVal > 150) category = "ä¸­åº¦æ±¡æŸ“";
        if (aqiVal > 200) category = "é‡åº¦æ±¡æŸ“";
        if (aqiVal > 300) category = "ä¸¥é‡æ±¡æŸ“";

        aqiEl.innerText = `${aqiVal} ${category}`;
        
        // ä½¿ç”¨ CSS ç±»æ¥æ§åˆ¶é¢œè‰²
        aqiEl.className = ''; // é‡ç½®
        aqiEl.style.opacity = "1";
        if (aqiVal <= 50) aqiEl.classList.add('aqi-good');
        else if (aqiVal <= 100) aqiEl.classList.add('aqi-mid');
        else aqiEl.classList.add('aqi-bad');
    } else {
        // ä¼˜é›…å¤„ç†æ— æƒé™æˆ–æ— æ•°æ®çš„æƒ…å†µ
        aqiEl.innerText = "æ— æƒé™";
        aqiEl.style.fontSize = "14px";
        aqiEl.style.opacity = "0.7";
        // ä¸æ˜¾ç¤ºå‡æ•°æ®ï¼Œä¿æŒè¯šå®ï¼Œä½†åœ¨æ§åˆ¶å°è¾“å‡ºåŸå› 
        console.warn("ç©ºæ°”è´¨é‡æ•°æ®ç¼ºå¤±:", air);
    }

    // 3. é¢„è­¦ä¿¡æ¯
    const alertBox = document.getElementById('weather-alert');
    if (warn.code === "200" && warn.warning?.length > 0) {
        alertBox.style.display = 'block';
        document.getElementById('alert-text').innerText = warn.warning[0].title;
    } else {
        alertBox.style.display = 'none';
    }

    // 4. æœªæ¥7å¤©é¢„æŠ¥ (é€‚é… Open-Meteo æ•°æ®ç»“æ„)
    const forecastContainer = document.getElementById('forecast-container');
    forecastContainer.innerHTML = '';

    if (daily && daily.daily && daily.daily.time) {
        const { time, weathercode, temperature_2m_max, temperature_2m_min, precipitation_probability_max } = daily.daily;
        
        time.forEach((dateStr, index) => {
            // åªæ˜¾ç¤ºæœªæ¥7å¤©ï¼ˆOpen-Meteo é»˜è®¤è¿”å›7å¤©ï¼Œindex 0 æ˜¯ä»Šå¤©ï¼‰
            // å¦‚æœè¦ä»æ˜å¤©å¼€å§‹æ˜¾ç¤ºï¼Œå¯ä»¥ index > 0
            
            const dateObj = new Date(dateStr);
            const dayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
            
            const div = document.createElement('div');
            div.className = 'forecast-day';
            div.innerHTML = `
                <span style="font-weight:bold">${dayNames[dateObj.getDay()]}</span>
                <span style="font-size:0.8rem; opacity:0.8">${dateStr.slice(5)}</span>
                <span style="font-size:1.2rem">${getWeatherIcon(weathercode[index])}</span>
                <span style="font-size:0.8rem; color:#87ceeb">ğŸ’§${precipitation_probability_max[index]}%</span>
                <span style="font-weight:500">${Math.round(temperature_2m_min[index])}Â°/${Math.round(temperature_2m_max[index])}Â°</span>
            `;
            forecastContainer.appendChild(div);
        });
    }
}

function getWeatherIcon(code) {
    // å…¼å®¹ Open-Meteo WMO Code (æ•°å­—) å’Œ å’Œé£å¤©æ°” (æ–‡æœ¬)
    if (typeof code === 'number') {
        // WMO Weather interpretation codes (WW)
        // 0: Clear sky
        // 1, 2, 3: Mainly clear, partly cloudy, and overcast
        // 45, 48: Fog and depositing rime fog
        // 51, 53, 55: Drizzle: Light, moderate, and dense intensity
        // 61, 63, 65: Rain: Slight, moderate and heavy intensity
        // 71, 73, 75: Snow fall: Slight, moderate, and heavy intensity
        // 95: Thunderstorm: Slight or moderate
        if (code === 0) return "â˜€ï¸";
        if (code <= 3) return "ğŸŒ¤ï¸";
        if (code <= 48) return "ğŸŒ«ï¸";
        if (code <= 55) return "ğŸŒ§ï¸"; // æ¯›æ¯›é›¨
        if (code <= 65) return "ğŸŒ§ï¸"; // é›¨
        if (code <= 77) return "â„ï¸"; // é›ª
        if (code <= 82) return "ğŸŒ§ï¸"; // é˜µé›¨
        if (code <= 86) return "â„ï¸"; // é›ªé˜µé›¨
        if (code <= 99) return "âš¡"; // é›·æš´
        return "ğŸŒ¡ï¸";
    }

    // å…¼å®¹æ—§é€»è¾‘ï¼ˆæ–‡æœ¬åŒ¹é…ï¼‰
    if (code.includes("æ™´")) return "â˜€ï¸";
    if (code.includes("äº‘")) return "ğŸŒ¤ï¸";
    if (code.includes("é˜´")) return "â˜ï¸";
    if (code.includes("é›¨")) return "ğŸŒ§ï¸";
    if (code.includes("é›ª")) return "â„ï¸";
    return "ğŸŒ¡ï¸";
}

window.onload = () => {
    initCityTabs();
    fetchWeather();
    const now = new Date();
    document.getElementById('date').innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
};
</script>
</body>
</html>
